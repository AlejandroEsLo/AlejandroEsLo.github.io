<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Reading Json</title>
    <meta name="description" content="Start">
  </head>

  <body>
    <script type="text/javascript">
    const request = new XMLHttpRequest();
    const requestURL = 'http_ejemplo.json';

    request.open('GET', requestURL);
    request.responseType = 'text';
    request.send();

    request.onload = function() {
      const dataTXT = request.response; // We take the response string
      const data = JSON.parse(dataTXT); // We convert it to an object
      //console.log(data);

      // Return data as string
      //console.log(JSON.stringify(data);

      // We get keys from our dictionary
      let num_keys = Object.keys(data);
      //console.log(num_keys);

      let num_packets = num_keys.length
      console.log("Total number of packets = " + num_packets);

      //Array to store all addresses
      let eth_total = [];
      let eth_fin = [];
      let ip_total = [];
      let ip_fin = [];
      var all_packet =[]; //Array de objetos{numero paquete,eth_dst,eth,src}
      var connections={}

      // Function to keep the unique addresses of the arrays
      Array.prototype.unique=function(a){
        return function(){return this.filter(a)}}(function(a,b,c){return c.indexOf(a,b+1)<0
      });

      // We go through the JSON file to get the addresses
      for (let i = 0; i < num_packets; i++) {

        for(key in data[i]._source){

          console.log("--------------------Paquete " + i + "------------------------");

          //----------<<<<< Ethernet Address >>>>>----------
          let acces1 = data[i]._source[key].eth
          //Destination Address
          let eth_dst = Object.values(acces1)[0]
          console.log("Ethernet Destination Address " + i + " => " + eth_dst);
          //Source Address
          let eth_src = Object.values(acces1)[2]
          console.log("Ethernet Source Address " + i + " => " + eth_src);

          // AÃ±adimos a nuestro array todas las direcciones que vamos encontrando
          eth_total.push(eth_dst)
          eth_total.push(eth_src)
          console.log("Ethernet TOTAL => " + eth_total);

          eth_fin = eth_total.unique();
          console.log("Ethernet UNICAS => " + eth_fin)

          let num_nodes_eth = eth_fin.length;
          console.log("Numero nodos finales Ethernet => " + num_nodes_eth)



          // -----------------------PROBANDO------------------------
          var packet_list = {packet: {numero: i, eth_dst: eth_dst, eth_src:eth_src}};

          console.log("Lista de paquetes => " + JSON.stringify(packet_list));
          all_packet.push(packet_list)
          console.log("Todos los paquetes => " + all_packet)

          // Prueba para datos del primer elemento del array
          // primer elemento array
          var p1 = Object.values(all_packet[i].packet)
          console.log("Primer elemento del array => " + p1)
          // numero de paquetes
          var pn = p1[0]
          console.log("Numero de paquete "+ i + " => " + pn)
          // direccion eth_destino
          var p_dst = p1[1]
          console.log("Direccion eth DESTINO "+ i + " => " + p_dst)
          //direccion eth_origen
          var p_src = p1[2]
          console.log("Direccion eth ORIGEN "+ i + " => " + p_src)

          //console.log("Elemento seleccionado => " + Object.values(all_packet[0].packet)[2])
          console.log("objetos %O:",packet_list)
          console.log("objetos %O:",all_packet)
          //----------------------------------------------------------

          var comparacion = [eth_src,eth_dst];
          var orden = comparacion.sort(); // ordenamos alfabeticamente
          var first_dir = orden[0];
          var second_dir = orden[1];

          console.log("<<<<<<<<<COMPARACION>>>>>>>> "+ i + " => " + comparacion)
          console.log("<<<<<<<<<ORDEN>>>>>>>> "+ i + " => " + orden)

          connections[first_dir+ '-' + second_dir] = {from: eth_src, to: eth_dst}

          console.log("<<<<<<<<<CONNECTIONS>>>>>>>> "+ i + " => " + JSON.stringify(connections))
          console.log("objetos %O:",connections)

          var elementos = Object.keys(connections).length
          console.log("Longitud => " + elementos)

          var key_connections = Object.keys(connections)
          console.log("Key => " + key_connections)

          var prop = connections[key_connections[i]];
          // Para obtener el valor del las propiedad from y to
          console.log("Direccion From => " + prop.from)
          console.log("Direccion To => " + prop.to)
          //{"dirA-dirB": {"from": "dirA", "to": "dirB"},
          //"dirC-dirD": {"from": "dirC", "to": "dirD"},
          //"dirC-dirE": {"from": "dirC", "to": "dirE"}



          //-----------------------------------------------------



          //----------<<<<< IP Address >>>>>----------
          let acces2 = data[i]._source[key].ip

          if (acces2 != undefined || acces2 != null) {
            //Destination Address
            let ip_dst = Object.values(acces2)[14]
            console.log("Ip Address " + i + " => " + ip_dst);
            //Source Address
            let ip_src = Object.values(acces2)[13]
            console.log("Ip Source Address " + i + " => " + ip_src);

            ip_total.push(ip_dst)
            ip_total.push(ip_src)
            console.log("IP TOTAL => " + ip_total);

            ip_fin = ip_total.unique();
            console.log("IP UNICAS => " + ip_fin);;

            let num_nodes_ip = ip_fin.length;
            console.log("Numero nodos finales IP => " + num_nodes_ip)

            //---------- <<<<<TIME RELATIVE >>>>>----------
            let acces3 = data[i]._source[key].frame
            let time_relative = Object.values(acces3)[6]
            console.log("Time relative " + i + " => " + time_relative);
          }
        }
      }
    }
    </script>
  </body>
</html>
